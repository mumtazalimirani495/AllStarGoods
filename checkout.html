<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AllStarGoods Checkout</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, textarea { width: 100%; padding: 8px; margin-top: 4px; }
    #cartSummary { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

  <h1>Checkout</h1>

  <form id="checkoutForm">
    <label>Name
      <input type="text" name="name" required>
    </label>
    <label>Phone
      <input type="tel" name="phone" required>
    </label>
    <label>Email
      <input type="email" name="email" required>
    </label>
    <label>Country
      <input type="text" name="country" required>
    </label>
    <label>Shipping Address
      <textarea name="shippingAddress" required></textarea>
    </label>

    <div id="cartSummary">
      <h3>Order Summary</h3>
      <ul id="cartItems"></ul>
      <strong>Total: <span id="totalPrice">0</span> USDT</strong>
    </div>

    <button type="submit">Proceed to Payment</button>
  </form>

  <script>
    const PRODUCTS_URL = 'products.json'; // adjust path if needed
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwy5WlZ-1ueoFiG36_O_yMhPGIU48oGNiDmktAqj6RDgl2Q8HLrRaC_iz-LvQggNWBh-g/exec';

    let cart = JSON.parse(localStorage.getItem('cart') || '[]'); 
    // cart should be array of { id: 'sku-cap', qty: 2 }

    let productsData = {};
    let totalPrice = 0;

    async function loadCart() {
      const res = await fetch(PRODUCTS_URL);
      const products = await res.json();
      products.forEach(p => productsData[p.id] = p);

      const cartItemsEl = document.getElementById('cartItems');
      totalPrice = 0;
      cartItemsEl.innerHTML = '';

      cart.forEach(item => {
        const prod = productsData[item.id];
        if (prod) {
          const lineTotal = prod.price * item.qty;
          totalPrice += lineTotal;
          const li = document.createElement('li');
          li.textContent = `${prod.name} x ${item.qty} â€” ${lineTotal.toFixed(2)} USDT`;
          cartItemsEl.appendChild(li);
        }
      });
      document.getElementById('totalPrice').textContent = totalPrice.toFixed(2);
    }

    document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;

      const payload = {
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        email: form.email.value.trim(),
        country: form.country.value.trim(),
        shippingAddress: form.shippingAddress.value.trim(),
        productIds: cart.map(c => c.id),
        orderId: 'order-' + Date.now()
      };

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.invoice_url) {
        // Clear cart after starting payment
        localStorage.removeItem('cart');
        window.location.href = data.invoice_url;
      } else {
        alert(data.error || 'Could not start payment');
      }
    });

    loadCart();
  </script>

</body>
</html>
